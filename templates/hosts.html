<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/static/style.css">

<div class="container">
  <h2>Manage Hosts</h2>
  <p>
    <a class="btn" href="/dashboard">Back to Dashboard</a>
    {% if not current_user_id or 'operator' in current_user_roles or 'admin' in current_user_roles %}
    <a class="btn" href="/hosts/arp_table">View ARP Table</a>
    <a class="btn btn-primary" href="/hosts/scan_ip_changes">üîç Scan for IP Changes</a>
    {% endif %}
  </p>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      {% for message in messages %}
        <div class="alert">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <h3>Existing Hosts</h3>
  {% if hosts %}
    {% for name, h in hosts.items() %}
      <div class="card">
        <b>{{ name }}</b>
        {% if h.host.lower() in localhost_identifiers %}
          <span class="badge-local">LOCAL</span>
        {% endif %}
        <br>
        Host: {{ h.host }}<br>
        User: {{ h.user }}<br>
        {% if h.mac %}
        MAC: {{ h.mac }}<br>
        {% endif %}
        <br>
        {% if not current_user_id or 'operator' in current_user_roles or 'admin' in current_user_roles %}
          <a class="btn" href="/hosts/edit/{{ name }}">Edit</a>
          {% if h.host.lower() not in localhost_identifiers %}
            <a class="btn" href="/hosts/install_key/{{ name }}">Install SSH key</a>
            {% if not h.mac %}
            <a class="btn btn-secondary" href="/hosts/detect_mac/{{ name }}">üîç Detect MAC</a>
            {% endif %}
          {% else %}
            <span class="text-muted">(No SSH key needed for localhost)</span>
          {% endif %}
          <form action="/hosts/delete/{{ name }}" method="post" style="display:inline">
            <button class="btn" type="submit" onclick="return confirm('Are you sure?')">Delete</button>
          </form>
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <p>No hosts configured yet.</p>
  {% endif %}

  {% if not current_user_id or 'operator' in current_user_roles or 'admin' in current_user_roles %}
  <h3>Add / Update Host</h3>
  <div class="card info-box">
    <p><strong><span aria-label="Tip">üí°</span> Tip:</strong> You can manage this local server by using <code>localhost</code> as the host. 
    No SSH key is needed for localhost - updates will run directly on this machine.</p>
    <p><strong>Example:</strong> Display name: "Local Server", Host: "localhost", User: (any value, will be ignored)</p>
    <p><strong><span aria-label="New">üÜï</span> IP Change Detection:</strong> Add a MAC address to enable automatic IP detection for DHCP hosts. 
    You can use the "Detect MAC" button to automatically discover it, or enter it manually.</p>
  </div>
  <form method="post" class="card">
    <label>Display name</label><br>
    <input name="name" placeholder="Friendly name"><br><br>
    <label>Host (IP or hostname)</label><br>
    <input name="host" placeholder="192.168.1.100 or localhost"><br><br>
    <label>User</label><br>
    <input name="user" placeholder="username (ignored for localhost)"><br><br>
    <label>MAC Address (optional, for IP change detection)</label><br>
    <input name="mac" placeholder="00:11:22:33:44:55"><br><br>
    <button class="btn" type="submit">Save</button>
  </form>
  {% else %}
  <p><em>You need operator or admin role to manage hosts.</em></p>
  {% endif %}
</div>
