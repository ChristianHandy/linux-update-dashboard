<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/static/style.css">

<div class="container">
  <h2>Manage Hosts</h2>
  <p><a class="btn" href="/dashboard">Back to Dashboard</a></p>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      {% for message in messages %}
        <div class="alert">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <h3>Existing Hosts</h3>
  {% if hosts %}
    {% for name, h in hosts.items() %}
      <div class="card">
        <b>{{ name }}</b>
        {% if h.host.lower() in localhost_identifiers %}
          <span class="badge-local">LOCAL</span>
        {% endif %}
        <br>
        Host: {{ h.host }}<br>
        User: {{ h.user }}<br>
        {% if h.os_name %}
          OS: <span style="color: #60a5fa; font-weight: 500;">{{ h.os_name|title }}{% if h.os_version and h.os_version != 'unknown' %} {{ h.os_version }}{% endif %}</span>
          {% if h.os_name == 'windows' %}
            <span style="background: #1e40af; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75rem; margin-left: 4px;">ü™ü</span>
          {% elif h.os_name in ['ubuntu', 'debian', 'fedora', 'centos', 'arch'] %}
            <span style="background: #047857; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75rem; margin-left: 4px;">üêß</span>
          {% endif %}
          <br>
        {% endif %}
        <br>
        {% if not current_user_id or 'operator' in current_user_roles or 'admin' in current_user_roles %}
          <a class="btn" href="/hosts/edit/{{ name }}">Edit</a>
          <a class="btn" href="/hosts/detect_os/{{ name }}" style="background: #0891b2;" title="Detect or refresh OS information">Detect OS</a>
          {% if h.host.lower() not in localhost_identifiers %}
            <a class="btn" href="/hosts/install_key/{{ name }}">Install SSH key</a>
          {% else %}
            <span class="text-muted">(No SSH key needed for localhost)</span>
          {% endif %}
          <form action="/hosts/delete/{{ name }}" method="post" style="display:inline">
            <button class="btn" type="submit" onclick="return confirm('Are you sure?')">Delete</button>
          </form>
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <p>No hosts configured yet.</p>
  {% endif %}

  {% if not current_user_id or 'operator' in current_user_roles or 'admin' in current_user_roles %}
  <h3>Add / Update Host</h3>
  <div class="card info-box">
    <p><strong><span aria-label="Tip">üí°</span> Tip:</strong> You can manage this local server by using <code>localhost</code> as the host. 
    No SSH key is needed for localhost - updates will run directly on this machine.</p>
    <p><strong>Example:</strong> Display name: "Local Server", Host: "localhost", User: (any value, will be ignored)</p>
  </div>
  <div class="card info-box" style="background: #1e293b; border: 1px solid #3b82f6;">
    <p><strong><span aria-label="Multiboot">üîÑ</span> Multi-boot / Dual-boot Support:</strong> For PCs with multiple operating systems (e.g., Windows and Linux), 
    the dashboard automatically detects which OS is currently running when you click <strong>"Detect OS"</strong>.</p>
    <p>The detected OS information is cached, so updates will always use the correct commands for the currently booted OS. 
    If you reboot into a different OS, simply click <strong>"Detect OS"</strong> again to update the information.</p>
    <p><strong>Example:</strong> A PC dual-booting Windows 11 and Ubuntu 22.04 will show the currently running OS after detection.</p>
  </div>
  <form method="post" class="card">
    <label>Display name</label><br>
    <input name="name" placeholder="Friendly name"><br><br>
    <label>Host (IP or hostname)</label><br>
    <input name="host" placeholder="192.168.1.100 or localhost"><br><br>
    <label>User</label><br>
    <input name="user" placeholder="username (ignored for localhost)"><br><br>
    <button class="btn" type="submit">Save</button>
  </form>
  {% else %}
  <p><em>You need operator or admin role to manage hosts.</em></p>
  {% endif %}
</div>
